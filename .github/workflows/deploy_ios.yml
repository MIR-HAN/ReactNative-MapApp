name: iOS App Store Deployment (React Native)

on:
  push:
    tags:
      - 'v*.*.*' # Sadece v*.*.* tag push'larƒ±nda √ßalƒ±≈üacak
  workflow_dispatch: # Manuel tetikleme

jobs:
  deploy:
    runs-on: macos-latest
    environment: production

    steps:
      # 1Ô∏è‚É£ Repo'yu checkout et
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Ruby 3.3 ve Bundler kur
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true

      - name: Verify Ruby version
        run: ruby -v

      # 3Ô∏è‚É£ Node.js kur (React Native i√ßin)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5'
          cache: 'npm'

      - name: Verify Node version
        run: node -v

      # 4Ô∏è‚É£ Proje baƒüƒ±mlƒ±lƒ±klarƒ±nƒ± y√ºkle (npm ile)
      - name: Install NPM Dependencies
        # Bu adƒ±m node_modules'√º kurar ve boost.podspec'i orijinal haline getirir.
        run: npm install --legacy-peer-deps

      # 5Ô∏è‚É£ Temizleme: Pod cache ve Podfile.lock
      - name: Clean iOS Pods and Cache
        run: |
          rm -rf ios/Pods ios/Podfile.lock
          pod cache clean --all
          
      # üõ†Ô∏è Nƒ∞HAƒ∞ YAMA: Checksum'u DEVRE DI≈ûI BIRAK ve GitHub Mirror'a GE√á
      - name: Patch boost.podspec to GitHub Mirror and Disable Checksum
        run: |
          BOOST_PODSPEC_PATH="./node_modules/react-native/third-party-podspecs/boost.podspec"
          
          if [ -f "$BOOST_PODSPEC_PATH" ]; then
            echo "üîß boost.podspec yamasƒ± ba≈ülatƒ±ldƒ± (GitHub Mirror + Checksum Devre Dƒ±≈üƒ±)..."
            
            # 1. Checksum satƒ±rƒ±nƒ± Podspec'ten Sƒ∞L (Bu, validasyonu atlatƒ±r!)
            # Hem 'sha256' hem de daha √∂nceki olasƒ± 'checksum' satƒ±rlarƒ±nƒ± siliyoruz.
            sed -i '' '/:sha256/d' "$BOOST_PODSPEC_PATH"
            sed -i '' '/:checksum/d' "$BOOST_PODSPEC_PATH"
            
            # 2. URL D√ºzeltmesi (Sorunlu Kaynaklar -> GitHub Mirror)
            # Bu, "Unrecognized archive format" hatasƒ±nƒ± √ß√∂zmeyi hedefler.
            GITHUB_MIRROR_URL="https://github.com/boostorg/boost/releases/download/boost-1.76.0/boost_1_76_0.tar.bz2"
            
            # SourceForge'dan gelen linki deƒüi≈ütir
            sed -i '' "s|https://downloads.sourceforge.net/project/boost/boost/1.76.0/boost_1_76_0.tar.bz2|$GITHUB_MIRROR_URL|g" "$BOOST_PODSPEC_PATH"
            # √ñnceki denemelerdeki archives.boost.io linkini deƒüi≈ütir
            sed -i '' "s|https://archives.boost.io/release/1.76.0/source/boost_1_76_0.tar.bz2|$GITHUB_MIRROR_URL|g" "$BOOST_PODSPEC_PATH"
            
            echo "‚úÖ boost.podspec yamasƒ± tamamlandƒ±. Checksum kontrol√º iptal edildi."

            # Yama i√ßeriƒüini kontrol edelim (SHA satƒ±rƒ±nƒ±n G√ñR√úNMEMESƒ∞ gerekir)
            echo "--- YAMADAN SONRA boost.podspec ƒ∞√áERƒ∞ƒûƒ∞ KONTROL√ú (SHA SATIRI YOK) ---"
            cat "$BOOST_PODSPEC_PATH" | grep -E "source|github.com"
            echo "---------------------------------------------------------------------"
            
          else
            echo "‚ùå HATA: boost.podspec bulunamadƒ±."
            exit 1
          fi

      # üõë KRƒ∞Tƒ∞K TEMƒ∞ZLƒ∞K ADIMI: CI Cache'ini zorla temizleme
      - name: Force Clean Cocoapods and Repos
        run: |
          echo "Force cleaning CocoaPods system cache and updating repos..."
          # Kullanƒ±cƒ± dizinindeki √∂nbelleƒüi siler (En inat√ßƒ± sorunlarƒ± √ß√∂zer)
          rm -rf ~/Library/Caches/CocoaPods 
          # Spec repolarƒ±nƒ± g√ºnceller
          pod repo update 
          
      # 6Ô∏è‚É£ iOS Pod'larƒ±nƒ± y√ºkle
      - name: Install iOS Pods
        run: |
          cd ios
          # Bu adƒ±m, SHA olmadan (Checksum atlandƒ±) ve GitHub Mirror URL'si ile √ßalƒ±≈ümalƒ±dƒ±r.
          pod install --repo-update

      # 7Ô∏è‚É£ P8 API Key dosyasƒ±nƒ± olu≈ütur
      - name: Create P8 Key File
        run: echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8

      # 8Ô∏è‚É£ Fastlane ile App Store'a deploy
      - name: Upload to App Store via Fastlane
        run: bundle exec fastlane deploy_appstore
        env:
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}"
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"

      # 9Ô∏è‚É£ Temizlik adƒ±mƒ±
      - name: Post-Job Cleanup
        if: always()
        run: rm -f AuthKey.p8