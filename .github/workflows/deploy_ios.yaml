# File: .github/workflows/deploy_ios.yml

name: iOS App Store Deployment (React Native) 

on:
  push:
    # 1. Prevent double triggering by only running on tag pushes
    branches: [] 
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # Enable manual triggering from the GitHub interface

jobs:
  deploy:
    runs-on: macos-latest
    environment: production 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- RUBY SETUP AND FIXES ---

      # 2. Force Ruby 3.2, disable caching, and specify Gemfile path to resolve the 3.0.7 lock issue.
      # --- MANUEL RUBY KURULUMU ve BUNDLER ---
      - name: Ruby 3.2'yi Kur (Kalıcı Kilitlenmeyi Aşmak İçin)
        # Sistemde yüklü olan Ruby 3.2'yi kullanmasını sağlıyoruz
        run: |
          RUBY_VERSION="3.2"
          # Sistemdeki 3.2 sürümünün yolunu PATH'e ekle (macos-latest üzerinde 3.2'nin yolu budur)
          echo "/opt/hostedtoolcache/Ruby/${RUBY_VERSION}/x64/bin" >> $GITHUB_PATH
          # Sürümün doğru kurulduğunu doğrula
          ruby -v

      - name: Eski Gemfile.lock'ı Sil (Ruby Kilitlenme Sorunu Çözümü)
        run: rm -f Gemfile.lock

      - name: Fastlane Bağımlılıklarını Kur (Manuel Bundle)
        # Kök dizindeki Gemfile'ı kullanarak, hiçbir önbellek kullanmadan 3.2 ile kurulum yap
        run: |
          bundle config set --local path 'vendor/bundle'
          # deployment flag'i yerine sadece gemfile'ı belirtiyoruz
          bundle install --gemfile=Gemfile --jobs 3

      # 3. Aggressive Fix: Delete Gemfile.lock in the CI environment to force bundle install 
      # to create a new lock file compatible with Ruby 3.2.
      - name: Delete Gemfile.lock (Fix Ruby 3.0.7 Lock)
        run: rm -f Gemfile.lock

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5' 

      # --- DEPENDENCIES AND PODS ---
      
      - name: Install Dependencies (npm)
        run: npm install --legacy-peer-deps 

      # 4. Clean up CocoaPods cache to solve the 'boost' checksum verification error.
      - name: Clean CocoaPods Cache and Update Repos
        run: |
          pod cache clean --all
          pod repo update
        
      - name: Install iOS Pods
        run: cd ios && pod install
        
      # --- FASTLANE AND CLEANUP ---
      
      - name: Create P8 Key File
        run: |
          echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8
          
      - name: Upload to App Store via Fastlane
        run: bundle exec fastlane deploy_appstore
        env:
          # --- Apple API and Fastlane Variables ---
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}" 
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"
          
      # 5. Safer Cleanup: Use 'rm -f' with 'if: always()' to ensure the workflow finishes 
      # even if the key file wasn't created due to an earlier failure.
      - name: Post-Job Cleanup
        if: always()
        run: rm -f AuthKey.p8