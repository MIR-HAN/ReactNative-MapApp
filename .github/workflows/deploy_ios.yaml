# File: .github/workflows/deploy_ios.yml

name: iOS App Store Dağıtımı (React Native) # İş Akışı Adı

on:
  push:
    # 1. Çift tetiklemeyi önlemek için sadece etiket (tag) gönderme olaylarında çalışır.
    branches: [] 
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # GitHub arayüzünden manuel başlatmayı etkinleştirir

jobs:
  deploy:
    runs-on: macos-latest # Apple derlemesi için en son Xcode/SDK içeren ortam
    environment: production 

    steps:
      - name: Kodu Çek
        uses: actions/checkout@v4

      # --- KURULUM ADIMLARI ---

      # 2. Ruby 3.2 sürümüne kilitlenmeye zorlamak için önbelleği (cache) devre dışı bırakıyoruz 
      # ve Gemfile yolunu açıkça belirtiyoruz.
      - name: Ruby Kurulumu
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' 
          bundler-cache: false
          gemfile: Gemfile # Kök dizindeki Gemfile'ı kullanmaya zorla

      - name: Node.js Kurulumu
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5' 

      - name: Bağımlılıkları Kur (npm)
        # Peer dependency sorunlarını çözmek için flag kullanıyoruz
        run: npm install --legacy-peer-deps 

      # 3. 'boost' pod checksum hatasını çözmek için Pods yüklemeden önce önbelleği temizliyoruz.
      - name: CocoaPods Önbelleğini Temizle ve Repo'ları Güncelle
        run: |
          pod cache clean --all
          pod repo update
        
      - name: iOS Pods Kurulumu
        run: cd ios && pod install
        
      # --- FASTLANE VE DERLEME ADIMLARI ---

      - name: P8 Anahtar Dosyasını Oluştur
        run: |
          echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8
          
      - name: Fastlane ile App Store'a Yükle
        run: bundle exec fastlane deploy_appstore
        env:
          # --- Apple API ve Fastlane Değişkenleri ---
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}" 
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          
          # --- Uygulama İçi API Anahtarı ---
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"
          
      # 4. Temizlik hatasını önlemek için (if: always) koşulu ve (-f) flag'i kullanılıyor.
      - name: İş Sonrası Temizlik
        if: always()
        run: rm -f AuthKey.p8