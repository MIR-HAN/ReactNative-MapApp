name: iOS App Store Deployment (React Native)

on:
  push:
    branches: []
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: macos-latest
    environment: production

    steps:
      # 1Ô∏è‚É£ Kodlarƒ± checkout et
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Ruby 3.3 kur ve bundler cache aktif et
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      # 3Ô∏è‚É£ Ruby baƒüƒ±mlƒ±lƒ±klarƒ±nƒ± y√ºkle
      - name: Install Ruby Dependencies
        run: |
          rm -f Gemfile.lock       # eski lock dosyasƒ±nƒ± temizle
          bundle install --jobs 3

      # 4Ô∏è‚É£ Node.js kur
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 5Ô∏è‚É£ JS baƒüƒ±mlƒ±lƒ±klarƒ±nƒ± y√ºkle
      - name: Install JS Dependencies
        run: npm install --legacy-peer-deps

      # 6Ô∏è‚É£ CocoaPods √∂nbelleƒüini temizle ve pod reposunu g√ºncelle
      - name: Clean CocoaPods Cache and Repos
        run: |
          pod cache clean --all
          pod repo update

      # 7Ô∏è‚É£ iOS podlarƒ±nƒ± y√ºkle
      - name: Install iOS Pods
        run: cd ios && pod install

      # 8Ô∏è‚É£ P8 key dosyasƒ±nƒ± olu≈ütur
      - name: Create P8 Key File
        run: echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8

      # 9Ô∏è‚É£ App Store‚Äôa Fastlane ile y√ºkle
      - name: Upload to App Store via Fastlane
        run: bundle exec fastlane deploy_appstore
        env:
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}"
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"

      # üîü Temizlik
      - name: Cleanup
        if: always()
        run: rm -f AuthKey.p8
