# File: .github/workflows/deploy_ios.yml

name: iOS App Store Deployment (React Native) 

on:
  push:
    # Prevent double triggering by only running on tag pushes
    branches: [] 
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # Enable manual triggering from the GitHub interface

jobs:
  deploy:
    runs-on: macos-latest 
    environment: production 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- RUBY KURULUMU: 3.3 SÜRÜMÜNÜ ZORLA (3.0.7 Kilidini Aşmak İçin) ---
      - name: Setup Ruby (Force 3.3 to bypass 3.0.7 lock)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3' # Başarılı olduğu görülen sürüm ailesini hedefliyoruz.
          bundler-cache: false # Önbelleği kesinlikle devre dışı bırak.
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5' 

      # Install Project Dependencies
      - name: Install Dependencies (npm/yarn)
        run: npm install --legacy-peer-deps 

      # CocoaPods Önbelleği (Ruby hatası çözüldüğünde boost hatası için bu adım gerekir)
      - name: Clean CocoaPods Cache and Repos
        run: |
          pod cache clean --all
          pod repo update
        
      - name: Install iOS Pods
        run: cd ios && pod install
        
      # Writes the P8 API Key content to a temporary file for security
      - name: Create P8 Key File
        run: |
          echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8
          
      # Upload to App Store using Fastlane
      - name: Upload to App Store via Fastlane
        run: bundle exec fastlane deploy_appstore
        env:
          # --- Apple API and Fastlane Variables (Authentication) ---
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}" 
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          
          # --- In-App API Key (Google Maps) ---
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"
          
      # --- TEMİZLİK HATASI ÇÖZÜMÜ ---
      - name: Post-Job Cleanup
        if: always()
        # Temizlik hatasını çözmek için 'rm -f' kullanıldı
        run: rm -f AuthKey.p8