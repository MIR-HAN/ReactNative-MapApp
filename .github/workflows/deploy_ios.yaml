# File: .github/workflows/deploy_ios.yml

name: iOS App Store Deployment (React Native) 

on:
  push:
    # Prevent double triggering by only running on tag pushes
    branches: [] 
    tags:
      - 'v*.*.*' 
  workflow_dispatch: # Enable manual triggering from the GitHub interface

jobs:
  deploy:
    runs-on: macos-latest 
    environment: production 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- MANUEL RUBY KURULUMU (KESİN ÇÖZÜM) ---
      # setup-ruby aksiyonu kaldırıldı. Başarılı senaryodaki PATH ekleme hilesini kullanıyoruz.
      - name: Force Ruby 3.3.x via PATH (Bypass 3.0.7 Lock)
        run: |
          # 3.2 PATH'ini zorla; Runner sistemi otomatik olarak 3.3.x'i bulup kullanacaktır.
          RUBY_VERSION="3.2"
          echo "/opt/hostedtoolcache/Ruby/${RUBY_VERSION}/x64/bin" >> $GITHUB_PATH
          ruby -v

      - name: Install Ruby Dependencies (Bundler)
        run: |
          # 1. Gemfile.lock dosyasını silerek yeni bir çözümlemeye zorla (Kalıntı kilitleri temizler)
          rm -f Gemfile.lock
          # 2. Bundler'ın yeni versiyonuna uygun olarak "deployment false" ayarını kullanıyoruz.
          bundle config set --local deployment false
          # 3. Path ayarını yap
          bundle config set --local path 'vendor/bundle'
          # 4. Yeni ayarlarla bundle install çalıştır
          bundle install --jobs 3
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.5' 

      - name: Install Dependencies (npm/yarn)
        run: npm install --legacy-peer-deps 

      # CocoaPods Önbelleği (Eski boost/checksum hatasına karşı koruma)
      - name: Clean CocoaPods Cache and Repos
        run: |
          pod cache clean --all
          pod repo update
        
      - name: Install iOS Pods
        run: cd ios && pod install
        
      # Writes the P8 API Key content to a temporary file for security
      - name: Create P8 Key File
        run: |
          echo "${{ secrets.P8_KEY_FILE_CONTENT }}" > AuthKey.p8
          
      # Upload to App Store using Fastlane
      - name: Upload to App Store via Fastlane
        run: bundle exec fastlane deploy_appstore
        env:
          # --- Apple API and Fastlane Variables (Authentication) ---
          API_KEY_PATH: ${{ github.workspace }}/AuthKey.p8
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          FASTLANE_ITC_TEAM_ID: "${{ secrets.FASTLANE_ITC_TEAM_ID }}" 
          FASTLANE_TEAM_ID: "${{ secrets.FASTLANE_TEAM_ID }}"
          FASTLANE_APPLE_ID: "${{ secrets.FASTLANE_APPLE_ID }}"
          FASTLANE_PASSWORD: "${{ secrets.FASTLANE_PASSWORD }}"
          
          # --- In-App API Key (Google Maps) ---
          MAPS_API_KEY: "${{ secrets.MAPS_API_KEY }}"
          
      # --- CLEANUP FIX ---
      - name: Post-Job Cleanup
        if: always()
        run: rm -f AuthKey.p8